{% extends "template.html" %}
{% block title %}Home{% endblock title %}
{% block pageTitle %}Search{% endblock pageTitle %}
{% block search_body %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
<form class="form-control min-w-full ml-2 -translate-y-[44rem] order-0" role="search" action="" autocapitalize="characters"
  autocomplete="off" id="search-form">
  {{ searchForm.csrf_token }}
  <div class="gradient-text text-2xl mb-2">
    <h1>Enter Stock Ticker:</h1>
  </div>
  <div class="input-group mb-3 flex">
    {% if searchForm.ticker.errors %}
    {{ searchForm.ticker(class="input input-bordered w-full", id="ticker") }}
    {% for error in searchForm.ticker.errors %}
    <span class="invalid-feedback">{{ error }}</span>
    {% endfor %}
    {% else %}
    {{ searchForm.ticker(class="input input-bordered w-full", id="ticker") }}
    {% endif %}
    <button class="btn btn-square" id="submit" name="submit" type="submit">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </button>
  </div>
</form>
<div class="" id="candle_div"></div>
<style>
  .highcharts-label.highcharts-range-input > text[style],
  .highcharts-label.highcharts-range-label > text[style] {
    fill: transparent !important;
    display: none !important;
  }

  .highcharts-scrollbar-thumb {
    fill: white !important;
  }
  .highcharts-scrollbar-thumb:hover {
    fill: rgb(210, 210, 210) !important;
  }
</style>
{{super()}}
{% endblock search_body %}
{{ super()}}
{% block search_results %}


{% if data != None %}
<div id="data" class="w-screen -translate-x-[8.5rem] -translate-y-[8.5rem]">
  {% if noResults %}
   <h3 class="text-center text-5xl font-bold gradient-text">No Results</h3>
  {% else %}
  
  <!-- <div class="h-screen w-screen grid "></div> -->
  <h1 class="text-5xl text-white mt-10 mb-10"><strong class="gradient-text">{{ ticker }}</strong> Monthly Aggregate Data from {{ data[0][0][0] }} to {{ data[0][0][1] }}</h1>
  <!-- Add star button here -->

  {% if current_identity != '' %}
    <button class="favorite-button" id="favorite-button">
      <div class="icon">
          <div class="star"></div>
      </div>
      <span>Favorite</span>
    </button>
  {% endif %}

  <div class="grid grid-cols-12 grid-rows-1 h-min max-h-max lg:w-full md:max-w-6xl md:shrink-0 p-4 ">
    <div class="grid col-span-9">
      <!-- graph -->
      
      
      <div class="card bg-base-100 shadow-xl mx-auto w-full h-full min-h-[44rem] border border-1 border-white/[0.1] " id="candle_div"></div>
      <!-- sentiment score -->
      {% if averageSentiment %} <!--If no tweets found on company.-->
        <h1 class="text-5xl gradient-text mt-10 mb-10">Sentiment Analysis</h1>
        
        <h3 class="text-xl mt-10 mb-10 text-center">Average Sentiment: <span class="gradient-text text-4xl">{{ averageSentiment }}</span></h3>
      {% endif %}
      <!-- tweets -->
      {% if tweets %}
      <h1 class="text-5xl mt-10 mb-10 gradient-text">Tweets:</h1>
      <div class="flex flex-col gap-y-10 md:gap-x-10 md:flex-row md:flex-wrap justify-center">
        <!-- {{ tweet }} -->
        {% for tweet in tweets %}
          {{ macros.card(
          title = tweet.user.name,
          text = ' https'.join(tweet.text.split(' https')[:-1]),
          button = 'Go to Tweet',
          buttonLink = 'https'+tweet.text.split('https')[-1],
          button_external = True,
          verified_tweet = True
          ) }}
        {% endfor %}
      </div>
      {% endif %}
      <!-- news -->
      {% if news %}
      <h1 class="text-5xl mt-10 mb-10 gradient-text">News:</h1>
      <div class="flex flex-col gap-y-10 md:gap-x-10 md:flex-row md:flex-wrap justify-center">
        <!-- {{ news }} -->
        {% for article in news %}
          {{ macros.card(
          title = article.title,
          text = '',
          button = 'Go to Article',
          buttonLink = article.link,
          button_external = True,
          verified_tweet = True
          ) }}
        {% endfor %}
      </div>
      {% endif %}
    </div>
    <div class="grid col-span-3 w-[32rem] px-12">
      <!-- stoc score -->
        {% if finance_analysis %}
          <h1 class="text-4xl gradient-text mt-10 mb-10 text-center">Financial Analysis</h1>
          <div class="-translate-y-[2.5rem]">
            <h3 class="text-sm mt-10 mb-16 text-center">\[P/E=\frac{\text{Share price}}{\text{Earnings per share}}={{finance_analysis['PE Ratio (TTM)']}}\]</h3>
            <h3 class="text-sm mt-10 mb-16 text-center">\[EPS=\frac{\text{Net income}-\text{Dividends on preferred stock}}{\text{Average outstanding common shares}}={{finance_analysis['EPS (TTM)']}}\]</h3>
            <h3 class="text-sm mt-10 mb-8 text-center">\[Composite\;Score=\frac{\text{Earnings before Interest and Taxes}}{\text{Net Fixed Assets}-\text{Working Capital}}={{finance_analysis['Composite Indicator']}}\]</h3>
          </div>
        {% endif %}
      <!-- table -->
      <!-- {% set showTable = false %} -->
      <!-- <button class="btn w-full border-3 border-primary/50 btn-ghost p-[18px]" url_for="">Open Section 1</button> -->
      <table class="table table-normal table-zebra w-full max-h-0">
        <thead class="hover:bg-primary">
          <tr class="hover:bg-primary">
            <th scope="col">Date</th>
            <th scope="col">Volume</th>
            <th scope="col">Vol. Wt. Avg.</th>
          </tr>
        </thead>
        <tbody>
          {% for i in range((data[0][2]).__len__()) %}
          <tr class="hover">
            <td>{{ data[0][1][i] }}</td>
            <td>{{ data[0][2]['volume'][i] }}</td>
            <td>{{ data[0][2]['vwap'][i] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <table class="table table-normal table-zebra w-full overflow-hidden max-h-0 mt-10">
        <thead class="hover:bg-primary">
          <tr class="hover:bg-primary">
            <th scope="col">Open</th>
            <th scope="col">Close</th>
            <th scope="col">Low</th>
            <th scope="col">High</th>
          </tr>
        </thead>
        <tbody>
          {% for i in range((data[0][2]).__len__()) %}
          <tr class="hover">
            <td>{{ data[0][2]['open'][i] }}</td>
            <td>{{ data[0][2]['close'][i] }}</td>
            <td>{{ data[0][2]['low'][i] }}</td>
            <td>{{ data[0][2]['high'][i] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="divider"></div>
      <h1 class="text-4xl gradient-text mt-10 mb-10 text-center">Insider Trading</h1>
      <ul>
        {% if insider_data %}
          {% for sentence in insider_data %}
              <li>{{ sentence }}</li>
          {% endfor %}
          {% else %}
              <li>No insider data found for {{ ticker }}.</li>
        {% endif %}
      </ul>
</div>
  {% endif %}
</div>
</div>
{% endif %}
{% endblock search_results %}

{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
<script src="{{ url_for('static', filename='js/star_button.js') }}"></script>
<script src="{{ url_for('static', filename='js/search.js') }}"></script>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/highcharts-3d.js"></script>
<script src="https://code.highcharts.com/modules/stock.js"></script>
<script src="https://code.highcharts.com/maps/modules/map.js"></script>
<script src="https://code.highcharts.com/modules/gantt.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/parallel-coordinates.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/modules/annotations-advanced.js"></script>
<script src="https://code.highcharts.com/modules/data.js"></script>
<script src="https://code.highcharts.com/modules/draggable-points.js"></script>
<script src="https://code.highcharts.com/modules/static-scale.js"></script>
<script src="https://code.highcharts.com/modules/broken-axis.js"></script>
<script src="https://code.highcharts.com/modules/heatmap.js"></script>
<script src="https://code.highcharts.com/modules/tilemap.js"></script>
<script src="https://code.highcharts.com/modules/timeline.js"></script>
<script src="https://code.highcharts.com/modules/treemap.js"></script>
<script src="https://code.highcharts.com/modules/treegraph.js"></script>
<script src="https://code.highcharts.com/modules/item-series.js"></script>
<script src="https://code.highcharts.com/modules/drilldown.js"></script>
<script src="https://code.highcharts.com/modules/histogram-bellcurve.js"></script>
<script src="https://code.highcharts.com/modules/bullet.js"></script>
<script src="https://code.highcharts.com/modules/funnel.js"></script>
<script src="https://code.highcharts.com/modules/funnel3d.js"></script>
<script src="https://code.highcharts.com/modules/pyramid3d.js"></script>
<script src="https://code.highcharts.com/modules/networkgraph.js"></script>
<script src="https://code.highcharts.com/modules/pareto.js"></script>
<script src="https://code.highcharts.com/modules/pattern-fill.js"></script>
<script src="https://code.highcharts.com/modules/price-indicator.js"></script>
<script src="https://code.highcharts.com/modules/sankey.js"></script>
<script src="https://code.highcharts.com/modules/arc-diagram.js"></script>
<script src="https://code.highcharts.com/modules/dependency-wheel.js"></script>
<script src="https://code.highcharts.com/modules/series-label.js"></script>
<script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
<script src="https://code.highcharts.com/modules/sonification.js"></script>
<script src="https://code.highcharts.com/modules/stock-tools.js"></script>
<script src="https://code.highcharts.com/modules/streamgraph.js"></script>
<script src="https://code.highcharts.com/modules/sunburst.js"></script>
<script src="https://code.highcharts.com/modules/variable-pie.js"></script>
<script src="https://code.highcharts.com/modules/variwide.js"></script>
<script src="https://code.highcharts.com/modules/vector.js"></script>
<script src="https://code.highcharts.com/modules/venn.js"></script>
<script src="https://code.highcharts.com/modules/windbarb.js"></script>
<script src="https://code.highcharts.com/modules/wordcloud.js"></script>
<script src="https://code.highcharts.com/modules/xrange.js"></script>
<script src="https://code.highcharts.com/modules/no-data-to-display.js"></script>
<script src="https://code.highcharts.com/modules/drag-panes.js"></script>
<script src="https://code.highcharts.com/modules/debugger.js"></script>
<script src="https://code.highcharts.com/modules/dumbbell.js"></script>
<script src="https://code.highcharts.com/modules/lollipop.js"></script>
<script src="https://code.highcharts.com/modules/cylinder.js"></script>
<script src="https://code.highcharts.com/modules/organization.js"></script>
<script src="https://code.highcharts.com/modules/dotplot.js"></script>
<script src="https://code.highcharts.com/modules/marker-clusters.js"></script>
<script src="https://code.highcharts.com/modules/hollowcandlestick.js"></script>
<script src="https://code.highcharts.com/modules/heikinashi.js"></script>

<!-- <script type="text/javascript">
  google.charts.load('current', { 'packages': ['corechart'] });

  function drawCharts() {
    drawCandleChart();
    drawSentimentChart();
  }

  function drawCandleChart() {
  {% if (data != None) %}
    var data = google.visualization.arrayToDataTable([
      {% for i in range((data[0][2]).__len__()) %}
        ["{{ data[0][1][i].__str__() }}", {{ data[0][2]['low'][i] }}, {{ data[0][2]['open'][i] }}, {{ data[0][2]['close'][i] }}, {{ data[0][2]['high'][i] }}],
      {% endfor %}
    ], true);

    var options = {
      legend: 'none',
      candlestick: {
        fallingColor: { strokeWidth: 0, fill: '#ff0000' }, // red
        risingColor: { strokeWidth: 0, fill: '#1EB854' },   // green
      },
      backgroundColor: { strokeWidth: 0, fill: '#171212' },
      chartArea: {
        backgroundColor: { strokeWidth: 0, fill: '#171212' },
      },
      hAxis: {
        title: 'Date',
        textStyle: {
          color: '#fff',
        },
        titleTextStyle: {
          color: '#fff'
        }
      },
      vAxis: {
        title: 'Price ($)',
        textStyle: {
          color: '#fff',
        },
        titleTextStyle: {
          color: '#fff'
        }
      },
      title: '{{ ticker }}, {{ data[0][1][0].__str__() }} - {{ data[0][1][-1].__str__() }}',
      titleTextStyle: {
        color: '#fff',
      },
    };

    var chart = new google.visualization.CandlestickChart(document.getElementById('candle_div'));

    chart.draw(data, options);
  {% endif %}
  }

  function drawSentimentChart() {
  {% if sentimentData.__len__() %}
    // Define the chart to be drawn.
    var data = google.visualization.arrayToDataTable([
      ['Sentiment', 'Frequency'],
      {% for i in range(sentimentData.__len__()) %}
        ['{{ i }}', {{ sentimentData[i]['Sentiment'] }}],
      {% endfor %}
    ]);

    var options = {
      legend: 'none',
      candlestick: {
        fallingColor: { strokeWidth: 0, fill: '#ff0000' }, // red
        risingColor: { strokeWidth: 0, fill: '#1EB854' },   // green
      },
      backgroundColor: { strokeWidth: 0, fill: '#171212' },
      chartArea: {
        backgroundColor: { strokeWidth: 0, fill: '#171212' },
      },
      colors: ['#1EB854'],
      hAxis: {
        title: 'Sentiment',
        textStyle: {
          color: '#fff',
        },
        titleTextStyle: {
          color: '#fff'
        }
      },
      vAxis: {
        title: 'Frequency',
        textStyle: {
          color: '#fff',
        },
        titleTextStyle: {
          color: '#fff'
        }
      },
      title: 'Sentiment of Tweets (Histogram)',
      titleTextStyle: {
        color: '#fff',
      },
      histogram: {
        bucketSize: 0.25,
        maxNumBuckets: 8,
        minValue: -1,
        maxValue: 1
      }
    };

    // Instantiate and draw the chart.
    var chart = new google.visualization.Histogram(document.getElementById('sentiment_div'));
    chart.draw(data, options);
  {% endif %}
  }
  
  google.charts.setOnLoadCallback(drawCharts);
</script> -->
{% endblock script %}


{% block footerClass %}fixed-bottom{% endblock footerClass %}